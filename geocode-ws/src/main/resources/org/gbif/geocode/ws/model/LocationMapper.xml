<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.gbif.geocode.ws.model.LocationMapper">

  <!--cache/-->
  <!-- TODO: Ensure most appropriate id (PID) -->

  <!-- Searches the public.political table -->
  <select id="listPolitical" resultType="Location">
    SELECT
      iso_a2 as id, <!-- TODO ensure complete and distinct -->
      'Political' AS type,
      'http://www.naturalearthdata.com' AS source,
      name AS title,
      iso_a2 AS isoCountryCode2Digit
    FROM political
    WHERE ST_DWithin(geom, ST_GeomFromText(#{point}, 4326), #{distance})
    ORDER BY ST_Distance(geom, ST_Geomfromtext(#{point},4326)) ASC
  </select>

  <!-- Searches the public.eez table -->
  <select id="listEez" resultType="Location">
    SELECT
      'http://marineregions.org/mrgid/' || eez.mrgid AS id,
      'EEZ' as TYPE,
      'http://vliz.be/vmdcdata/marbound/' as SOURCE,
      eez.geoname AS title,
      iso_map.iso2 AS isoCountryCode2Digit
    FROM eez LEFT OUTER JOIN iso_map ON eez.iso_ter1 = iso_map.iso3
    WHERE ST_DWithin(eez.geom, ST_GeomFromText(#{point}, 4326), #{distance})
    ORDER BY ST_Distance(eez.geom, ST_Geomfromtext(#{point},4326)) ASC
  </select>

  <!-- Searches the public.gadm table -->
  <select id="listGadm" resultType="Location">
    SELECT
      COALESCE(gid_5, gid_4, gid_3, gid_2, gid_1, gid_0) AS id,
      'GADM' as TYPE,
      'http://gadm.org/' as SOURCE,
      COALESCE(name_5, name_4, name_3, name_2, name_1, name_0) AS title,
      iso_map.iso2 AS isoCountryCode2Digit
    FROM gadm LEFT OUTER JOIN iso_map ON gadm.gid_0 = iso_map.iso3
    WHERE ST_DWithin(gadm.wkb_geometry, ST_GeomFromText(#{point}, 4326), #{distance})
    ORDER BY ST_Distance(gadm.wkb_geometry, ST_Geomfromtext(#{point},4326)) ASC
  </select>

  <!-- Searches the public.iho table -->
  <select id="listIho" resultType="Location">
    SELECT
      'http://marineregions.org/mrgid/' || mrgid AS id,
      'IHO' as TYPE,
      'http://marineregions.org/' as SOURCE,
      name AS title
    FROM iho
    WHERE ST_DWithin(geom, ST_GeomFromText(#{point}, 4326), #{distance})
    ORDER BY ST_Distance(geom, ST_Geomfromtext(#{point},4326)) ASC
  </select>

  <!-- Searches the public.seavox table -->
  <select id="listSeaVoX" resultType="Location">
    SELECT
      skos_url AS id,
      'SeaVox' as TYPE,
      'http://marineregions.org/' as SOURCE,
      sub_region AS title
    FROM seavox
    WHERE ST_DWithin(geom, ST_GeomFromText(#{point}, 4326), #{distance})
    ORDER BY ST_Distance(geom, ST_Geomfromtext(#{point},4326)) ASC
  </select>

  <!-- Searches the public.geolocate_centroids table -->
  <select id="listGeolocateCentroids" resultType="Location">
    SELECT
      gc.gid AS id,
      'GEOLOCATE_CENTROIDS' as TYPE,
      'http://geo-locate.org/webservices/geolocatesvcv2/' as SOURCE,
      gc.iso_a2 AS isoCountryCode2Digit
    FROM geolocate_centroids gc
    WHERE ST_DWithin(gc.geom, ST_GeomFromText(#{point}, 4326), #{distance})
    ORDER BY distance ASC
  </select>

</mapper>

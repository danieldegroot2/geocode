Map Image Lookup
================

The class `BitmapFirstGeocoder` refers to a PNG bitmap of the world, with each country having a unique colour, and international water being white.  Borders and EEZs are black, and are still looked up using the database.  A histogram generated by a graphics editor says 50.5% of the image is either international water or a large, coloured country.  Queries to these areas are almost instant, and the international water ones are particularly slow using the database.

![PNG map cache](src/main/resources/org/gbif/geocode/ws/service/resource/world.png)

## Process to generate the map image

The bitmap is generated using data from MarineRegions.org, the same data source as is used in our database.

To give a large margin for error, country and EEZ borders are drawn with thick, black lines.  These places must be looked up in the database.  Performance could be improved if the line thickness were reduced, but at the highest latitudes a couple of pixels can cover quite a large distance on the ground.

1. Download the map data.

The Marine EEZ map will be the bottom layer.

    wget -O 'world-marineregions.svg' 'http://geo.vliz.be/geoserver/MarineRegions/wms?service=WMS&version=1.1.0&request=GetMap&layers=MarineRegions:eez&styles=&bbox=-180,-90,180,90&width=800&height=400&srs=EPSG:4326&format=image%2Fsvg'

The World Countries map will be the middle layer.

    wget -O 'world-countries.svg' 'http://geo.vliz.be/geoserver/World/wms?service=WMS&version=1.1.0&request=GetMap&layers=World:worldcountries&styles=&bbox=-180.0,-90.0,180.0,90&width=800&height=400&srs=EPSG:4326&format=image%2Fsvg'

South Sudan is missing from the Marine EEZ map, so download the Marine EEZ + Land map.

    wget -O 'world-eezland.svg' 'http://geo.vliz.be/geoserver/MarineRegions/wms?service=WMS&version=1.1.0&request=GetMap&layers=MarineRegions:eez_land&styles=&bbox=-180,-90,180,90&width=800&height=400&srs=EPSG:4326&format=image%2Fsvg'

2. Combine and style the maps.

    cp world-marineregions.svg world.svg

Open this in a text editor, and remove the styling attributes from the SVG element.  Add the general CSS styles (for `path` and `#eez_land`).

````css
<style type="text/css">
    path {
        stroke: #000000;
        stroke-width: 2.5px;
        stroke-linecap: round;
        stroke-linejoin: round;
        fill: #000000;
    }
    #eez_land > path {
        fill: #888888 !important;
    }
</style>
````

At the end of the file, in a new layer (`g` element) add the layer from the World Countries map.

Then, find the `path` element which represents South Sudan (I used Inkscape and the XML Editor / Inspector) and paste this into another layer.

Generate a UUID for every `path` element.  I did this using an Emacs macro (`F3`, `C-S path space enter`, `id="`, `C-U M-! uuidgen enter`, `backspace`, `" `, `F4`. Then `F4` to rerun the macro).

3. Colour in the countries and EEZs.

Find the UUIDs.

    grep 'id="[a-f0-9-]*"' world.svg --only-matching | sed 's/id=.//' | tr -d '"' >! world.svg.ids

Generate a unique colour for all of them (you may need to increase the number of hues used, if there are more countries/zones).

    java org.gbif.geocode.ws.util.MakeColours < world.svg.ids >! colours.html

Get those IDs:

    grep '^#' colours.html >! css-colours.css

Insert them into the `style` element of the SVG (Emacs: `M-x insert-file`).

4. Convert the SVG to a PNG.

Open the file in an SVG editor.  I used Inkscape.  Inkscape will only output an anti-aliased bitmap, which is no use to us.  To work around that:

a) Export as PDF.

b) Use GhostScript to turn this into a PNG:

    gs -dSAFER -dBATCH -dNOPAUSE -sDEVICE=png16m -r90 -sOutputFile=world.png world.pdf

Have a look.  Check that the borders are thick enough, they should represent 100km or so at reasonable latitudes.  EEZs are grey, until further optimization of the web service is required.
